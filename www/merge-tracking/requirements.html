<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<style type="text/css"> /* <![CDATA[ */
  @import "tigris-branding/css/tigris.css";
  @import "tigris-branding/css/inst.css";
  /* ]]> */</style>
<link rel="stylesheet" type="text/css" media="print"
  href="tigris-branding/css/print.css"/>
<script type="text/javascript" src="tigris-branding/scripts/tigris.js"></script>
<title>Merge Tracking Use Cases and Requirements</title>
</head>

<body>
<div class="h2">
<h2>Merge Tracking</h2>

<p>Specification of <a href="index.html">merge tracking</a> use cases
and requirements.  <span style="font-color: red">This document is
still UNDER CONSTRUCTION.</span></p>


<div class="h3"> <!-- id="use-cases" -->
<h3>Use Cases and Requirements</h3>

<p>The majority of Subverion's merge tracking use cases and
requirements are driven by its <a
href="../user-classifications.html#developer">Developer</a> and <a
href="../user-classifications.html#merge-meister">Merge Meister</a>
users.  A few outliers are driven by <a
href="../user-classifications.html#program">SCM automation</a>.</p>

<p>TODO: Incorporate <a
href="http://svn.collab.net/repos/svn/trunk/notes/repeated-merging"
>repeated-merging</a>, and CollabNet Summit findings.</p>

<div id="misc">
<h4>Miscellaneous Thoughts</h4>

<ul>
  <li>If you merge rN into some destination (e.g., into branch B), it
  should be possible to query rN itself to ask what destinations it
  has been merged to, and the answer set should contain B.</li>

  <li>If you merge rN into a branch B, and rN was committed by author A,
  then 'svn blame' should show the changed lines in B as last touched
  by A, even if the merge was committed by you and you are not A.
  (Hmm, this gets tough to implement when one merges a range of
  revisions simultaneously!)</li>

  <li>It should be possible to query any path (file or directory) to
  find out what changes (revisions) have been merged under it.  For
  files, "under" just means "into".</li>

  <li>It should be easy to discover all the paths at which a particular
  node revision (i.e., unique versioned file entity) exists,
  especially in a given revision.  IOW, this is the "what branches
  does this exact version of this file exist in" problem, often
  requested by so-called enterprise-level users.</li>

  <li>Merge records should be transitive.  Often we merge a bunch of
  changes to a backport branch, tweak them there, then later merge the
  branch into a release line.  Later queries of the release line
  should show that the original revisions are present, and queries
  of the original revisions should show that they went to the release
  line as well as the backport branch.</li>
</ul>

</div>  <!-- misc -->

<div id="cherry-picking">
<h4>Cherry Picking</h4>

<p>Merge of individual changes from branchA into branchB.
<!-- TODO: Elaborate. --></p>

</div>  <!-- cherry-picking -->

<div id="repeated-merge">
<h4>Repeated Merge</h4>

<p>Track which changesets have been applied where, so users can <a
href="http://svn.collab.net/repos/svn/trunk/notes/repeated-merging"
>repeatedly merge</a> branchA to branchB without having to remember
the last range of revisions ported.  This would also track changeset
<a href="#cherry-picking">cherry-picking</a> done by users, so we
don't accidentally re-merge changesets that are already applied.  This
is the problem that <a href="http://svk.elixus.org/">svk</a> and <a
href="http://www.gnu.org/software/gnu-arch/">arch</a> claim to have
already solved, what they're calling <em>star-merge</em>.</p>

</div>  <!-- repeated-merge -->

<div id="aslb-merge">
<h4>Ancestry-Sensitive Line-Based Merge</h4>

<p>Make 'hunks' of contextually-merged text sensitive to ancestry.</p>

<p>A high-resolution version of <a href="#repeated-merge">Repeated
Merge</a>.  Rather than tracking whole changesets, we track the
lineage of specific lines of code within a file.  The basic idea is
that when re-merging a particular hunk of code, the contextual-merging
process is aware that certain lines of code already represent the
merging of particular lines of development.  Jack Repenning has a
great example of this from Clearcase, which we can draw in this space.
See diagram at the bottom for an explanation.</p>

<p>See the <a href="../variance-adjusted-patching.html">variance
adjusted patching</a> document for an extended discussion of how to
implement this by composing diffs; see svn_diff_diff4() for an
implementation of same.  We may be closer to ancestry-sensitive
merging than we think.</p>

<p>Here's an example demonstrating how individual lines of code can be
tracked.  In this diagram, we're drawing the lineage of a single file,
with time flowing downwards.  The file begins life with three lines of
text, "1\n2\n\3\n".  The file then splits into two lines of
development.</p>

<pre>
                    1     
                    2     
                    3     
                  /   \   
                 /     \  
                /       \ 
            one           1   
            two           2.5 
            three         3   
             |     \      |
             |      \     |   
             |       \    |            
             |        \   |            
             |         \ one                ## This node is a human's
             |           two-point-five     ## merge of two sides.
             |           three        
             |            |
             |            |
             |            |
            one          one
            Two          two-point-five
            three        newline       
               \         three  
                \         |   
                 \        |
                  \       |
                   \      |
                    \     |
                     \    |
                      \   |
                       \  |
                         one                ## This node is a human's
                         Two-point-five     ## merge of the changes
                         newline            ## since the last merge.
                         three
</pre>

<p>It's the second merge that's important here.</p>

<p>In a system like Subversion, the second merge of the left branch to
the right will fail miserably: the whole file's contents will be
placed within conflict markers.  That's because it's trying to dumbly
apply a patch that changes "1\n2\n3" to "one\nTwo\nthree", and the
target file has no matching lines at all.</p>

<p>A smarter system (like Clearcase) would remember that the previous
merge had happened, and specifically notice that the lines "one" and
"three" are the results of that previous merge.  Therefore, it would
ask the human only to deal with the "Two" versus "two-point-five"
conflict; the earlier changes ("1\n2\n3" to "one\ntwo\nthree") would
already be accounted for.</p>

</div>  <!-- aslb-merge -->


<div id="rename-tracking">
<h4>Track Renames in Merge</h4>

<p><code>svn merge</code> needs to handle renames better.  This
requires <a
href="http://subversion.tigris.org/issues/show_bug.cgi?id=898">true
rename support</a>.</p>

<p>Edit foo.c on branchA.  Rename foo.c to bar.c on branchB.</p>

<ol>
  <li>Try merging the branchA edit into a working copy of branchB:
  <code>svn merge</code> will skip the file, because it can't find
  it.</li>

  <li>Conversely, try merging branchB rename to branchA: <code>svn
  merge</code> will delete the 'newer' version of foo.c and add bar.c,
  which has the older text.</li>
</ol>

<p>Problem #2 stems from the fact that we don't have <a
href="http://subversion.tigris.org/issues/show_bug.cgi?id=898">true
renames</a>, just copies (with history) and deletes.  That's not
fixable without a FS schema change, and (probably) a libsvn_wc
rewrite.</p>

<p>It's not clear what it would take to solve problem #1.  See <a
href="http://www.contactor.se/~dast/svn/archive-2004-07/0084.shtml">the
discussion</a> about our rename woes, and the relationship to merge
tracking.</p>

</div>  <!-- rename-tracking -->

<div id="dump-load">
<h4>Allow for Dump/Load</h4>

<p>Whatever solution is chosen must play well with <code>svnadmin
dump</code> and <code>svnadmin load</code>.  For example, the metadata
used to store merge tracking history must not be stored in terms of
some filesystem backend implementation detail (e.g.
"node-revision-ids") unless, perhaps, those IDs are present for all
items in the dump as a sort of "soft data" (which would allow them to
be used for "translating" the merge tracking data at load time, where
those IDs would be otherwise irrelevant).  See <a
href="http://subversion.tigris.org/issues/show_bug.cgi?id=1525">issue
1525</a> about user-visible entity IDs.</p>

</div>  <!-- dump-load -->

<div id="automated-merge">
<h4>SCM Automated Merge</h4>

<p>The ability to automate merges (e.g. from a stable branch to a
development branch), including interfaces for resolving conflicts and
handling other errors, is important.  Merge Meister who do
multi-thousand file merges stress this.</p>

</div>  <!-- automated-merge -->

</div>  <!-- use-cases -->

<!--
<div class="h3" id="requirements">
<h3>Requirements</h3>

<p>For now, for the sake of getting everything written down in one
place, we'll lump requirements and uses cases together in the "Use
Cases" section.</p>


</div>  <! - - requirements -->


<div class="h3" id="related-documents">
<h3>Related Documents and Discussion</h3>

<p>TODO: Many of these documents should be consolidated into the
requirements, functional, and design specification pages of this Merge
Tracking area.  Others may be better off linked from the
functional/design spec pages.</p>

<ul>
  <li><a href="summit.html">CollabNet Enterprise customer summit on
  Merge Tracking</a></li>

  <li><a
  href="http://svn.collab.net/repos/svn/trunk/notes/EuroOSCON-2005-vc-bof.txt"
  >EuroOSCON-2005-vc-bof.txt</a>: Has some merging notes scattered
  throughout.</li>

  <li><a
  href="http://svn.collab.net/repos/svn/trunk/notes/schema-tradeoffs.txt"
  >schema-tradeoffs.txt</a>: Search for the section called "Questions
  that Users Ask".</li>

<!-- TODO: "Import" from Karl's site:
  <li><a href="merge-history/threads.html">Various merging threads
  from dev@svn</a></li>

  <li><a href="jackr-diff-merge-syntax/threads.html">Mail from Jack
  Repenning about diff/merge syntax</a></li>
-->
  <li><a
  href="http://thread.gmane.org/gmane.comp.version-control.revctrl/2"
  >Bram Cohen describes Codeville's merge algorithm</a></li>

  <li><a
  href="http://lists.zooko.com/pipermail/revctrl/2005-May/000012.html"
  >Bram Cohen muses on rename/copy, etc</a></li>
</ul>

</div>  <!-- related-documents -->

</div>  <!-- h2 -->
</body>
</html>
